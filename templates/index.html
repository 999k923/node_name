<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Node Manager</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed; /* 固定列宽 */
        }
        th, td {
            border: 1px solid #ccc;
            padding: 4px;
            text-align: left;
            word-wrap: break-word; /* 长文本换行 */
        }
        td.link-column {
            max-width: 300px; /* 限制链接列最大宽度 */
            overflow: hidden;
            text-overflow: ellipsis; /* 超长显示省略号 */
            white-space: nowrap; /* 不换行，显示省略号 */
        }
        td.name-column {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        ul {
            list-style-type: none;
            padding-left: 0;
        }
    </style>
</head>
<body>
    <h1>节点管理后台</h1>

    <!-- 添加单节点 -->
    <form action="{{ url_for('add_node') }}" method="post">
        名称: <input type="text" name="name" required>
        链接: <input type="text" name="link" required>
        <button type="submit">添加节点</button>
    </form>

    <!-- 导入订阅集合 -->
    <form action="{{ url_for('import_sub') }}" method="post">
        订阅 URL: <input type="text" name="sub_url" required>
        <button type="submit">导入订阅</button>
    </form>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul>
        {% for category, message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <h2>订阅集合列表</h2>
    <ul>
        {% for group in groups %}
            <li>
                {{ group.url }}
                <a href="{{ url_for('delete_group', group_id=group.id) }}">删除订阅集合</a>
                <ul>
                    {% for node in nodes if node.group_id == group.id %}
                        <li>
                            {{ node.sort_order }} - {{ node.name }} - 
                            <span style="max-width: 300px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ node.link }}</span> - 
                            {{ '✅' if node.enabled else '❌' }}
                            <a href="{{ url_for('move_up', node_id=node.id) }}">↑</a>
                            <a href="{{ url_for('move_down', node_id=node.id) }}">↓</a>
                            <a href="{{ url_for('toggle_node', node_id=node.id) }}">切换</a>
                            <a href="{{ url_for('delete_node', node_id=node.id) }}">删除</a>
                            <form action="{{ url_for('edit_node', node_id=node.id) }}" method="post" style="display:inline">
                                名称: <input type="text" name="name" value="{{ node.name }}">
                                链接: <input type="text" name="link" value="{{ node.link }}">
                                <button type="submit">修改</button>
                            </form>
                        </li>
                    {% endfor %}
                </ul>
            </li>
        {% endfor %}
    </ul>

    <h2>独立节点列表</h2>
    <table>
        <tr>
            <th>ID</th>
            <th class="name-column">名称</th>
            <th class="link-column">链接</th>
            <th>启用</th>
            <th>操作</th>
        </tr>
        {% for node in nodes if not node.group_id %}
        <tr>
            <td>{{ node.id }}</td>
            <td class="name-column">{{ node.name }}</td>
            <td class="link-column">{{ node.link }}</td>
            <td>{{ '✅' if node.enabled else '❌' }}</td>
            <td>
                <a href="{{ url_for('move_up', node_id=node.id) }}">↑</a>
                <a href="{{ url_for('move_down', node_id=node.id) }}">↓</a>
                <a href="{{ url_for('toggle_node', node_id=node.id) }}">切换</a>
                <a href="{{ url_for('delete_node', node_id=node.id) }}">删除</a>
                <form action="{{ url_for('edit_node', node_id=node.id) }}" method="post" style="display:inline">
                    名称: <input type="text" name="name" value="{{ node.name }}">
                    链接: <input type="text" name="link" value="{{ node.link }}">
                    <button type="submit">修改</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>
</body>
</html>
